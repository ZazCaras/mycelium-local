services:
  nginx:
    image: nginx:latest
    ports:
      - "8080:80"  # Puerto 8080 para Nginx
    volumes:
      - ./nginx-config:/etc/nginx/conf.d
    networks:
      - mycelium-local

  # api:
  #   image: localhost/mycelium-local_api:dev
  #   ports:
  #     - "8081:8080"  # Puerto 8081 para el servicio API
  #   volumes:
  #     - ./api:/app:rw
  #     - gradle:/var/lib/gradle:rw
  #   build:
  #     context: api
  #     dockerfile: Dockerfile.dev
  #   networks:
  #     - mycelium-local
  #   environment:
  #     - VIRTUAL_PATH=~^/(api|swagger|swagger-ui)
  #     - VIRTUAL_PORT=8080
  #   depends_on:
  #     - db

  client:
    image: localhost/mycelium-local_client:dev
    ports:
      - "3000:3000"  # Puerto 3000 para el cliente
    volumes:
      - ./client:/app:rw
    build:
      context: client
      dockerfile: Dockerfile.dev
    networks:
      - mycelium-local
    environment:
      - VIRTUAL_PATH=/
      - VIRTUAL_PORT=3000

  # db:
  #   image: container-registry.oracle.com/database/express:21.3.0-xe
  #   ports:
  #     - "1521:1521"  # Puerto 1521 para la base de datos
  #   restart: unless-stopped
  #   environment:
  #     ORACLE_PWD: "12345"
  #   volumes:
  #     - oracledb:/opt/oracle/oradata
  #   networks:
  #     - mycelium-local

  jenkins:
    image: jenkins/jenkins:lts-jdk17 
    ports:
      - "7000:8080"  # Puerto 7000 para Jenkins
    volumes:
      - jenkins_data:/var/jenkins_home
    networks:
      - mycelium-local

  drone: 
    image: drone/drone:2
    networks:
      - mycelium-drone
      - mycelium-local
    ports:
      - "7001:80"
    volumes:
      - /var/lib/drone:/data
    environment:
      - DRONE_GITHUB_CLIENT_ID=c85a7d32364613774834
      - DRONE_GITHUB_CLIENT_SECRET=b4b7aaa41cee5a20d41bfe228907df5dee2f5185 
      - DRONE_RPC_SECRET=98603fac90abd2dd2fb4de2c6997e573
      - DRONE_SERVER_HOST=150.136.162.189:9051
      - DRONE_SERVER_PROTO=http

  drone-runner: 
    image: drone/drone-runner-docker:1
    networks:
      - mycelium-drone
      - mycelium-local
    volumes: 
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DRONE_RPC_PROTO=http
      - DRONE_RPC_HOST=drone:80
      - DRONE_RPC_SECRET=98603fac90abd2dd2fb4de2c6997e573
      - DRONE_RUNNER_CAPACITY=2
      - DRONE_RUNNER_NAME=mycelium-runner
    ports:
      - "7002:7002"

  sonarqube:
    image: sonarqube:lts
    ports:
      - "9000:9000"
    networks:
      - mycelium-sonarqube
      - mycelium-local
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://sonarqube-db:5432/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: Test12345
    volumes:
      - sonarqube_conf:/opt/sonarqube/conf
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions

  sonarqube-db:
    image: postgres
    networks:
      - mycelium-sonarqube
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=Test12345
    volumes:
      - postgresql:/var/lib/postgresql
      - postgresql_data:/var/lib/postgresql/data

#https://gist.github.com/pavankjadda/b8815276318c5f4dfaba8da2c177be5e

volumes:
  # oracledb: 
  gradle: 
  jenkins_data: 
  sonarqube_conf:
  sonarqube_data:
  sonarqube_extensions:
  postgresql:
  postgresql_data:

networks:
  mycelium-local:
    driver: bridge
  mycelium-sonarqube:
    driver: bridge
  mycelium-drone:
    driver: bridge